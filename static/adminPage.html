<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FiguraLab</title>
  <link rel="icon" href="img/reno.png" type="image/png" sizes="32x32">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="css/adminPage.css">
</head>

<body>
  <div id="header-placeholder"></div>
  <!-- ----------------------------------contenido------------------------- -->
  <br>
  <nav class="nav">
    <h1>Administrador de productos</h1>
    <button type="button" class="btn btn-outline-warning m-5" data-bs-toggle="modal"
      data-bs-target="#staticBackdrop">Nuevo Producto</button>
  </nav>
  <br>
  <div class="table-responsive">
    <table class="table table-striped align-middle" id="tablaProductos">
      <thead>
        <tr>
          <th>#</th>
          <th>Producto</th>
          <th>Precio</th>
          <th>Stock</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  </main>
  <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">Nuevo Producto</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="form-floating mb-3">
            <input type="text" class="form-control" id="prodName" placeholder="Nombre del producto">
            <label for="prodName">Nombre Producto</label>
          </div>
          <div class="form-floating mb-3">
            <input type="number" class="form-control" id="prodStock" placeholder="Stock">
            <label for="prodStock">Cantidad</label>
          </div>
          <div class="form-floating mb-3">
            <input type="number" class="form-control" id="prodPrice" placeholder="Precio">
            <label for="prodPrice">Precio</label>
          </div>
          <div class="mb-3">
            <label class="form-label">Imagen (JPG/PNG, máx ~1MB)</label>
            <input id="prodImg" type="file" accept="image/*" class="form-control">
            <div class="form-text">Opcional. Si no subes, se usará una imagen por defecto.</div>
          </div>
        </div>
        <!-- FOOTER DEL MODEL -->
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveProdBtn" class="btn btn-warning">Guardar</button>
        </div>
      </div>
    </div>
  </div>
  <div id="footer-placeholder"></div>
  
  <script src="js/users.js"></script>  
  <script src="js/controlSeccion.js"></script>
  <script>
    fetch('header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('header-placeholder').innerHTML = html;
        applySessionUI(); 
      })
      .catch(error => console.error('Error al cargar el header:', error));
  </script>
 
  <script>
    fetch('footer.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('footer-placeholder').innerHTML = html;
      })
      .catch(error => console.error('Error al cargar el footer:', error));
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- ACA SE EJECUTA EL CONTROL DE PRODUCTO -->
  <script src="js/productos.js"></script>
  <script>
    const nameInput = document.getElementById("prodName");
    const stockInput = document.getElementById("prodStock");
    const priceInput = document.getElementById("prodPrice");
    const imgInput = document.getElementById("prodImg");
    function renderProducts() {
      const tbody = document.querySelector("#tablaProductos tbody");
      tbody.innerHTML = "";
      const all = products.getProducts();
      all.forEach((p, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${p.name}</td>
        <td>$${p.price}</td>
        <td>${p.stock}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary me-2" onclick="editProduct('${p.id}')">Editar</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteProductAction('${p.id}')">Eliminar</button>
        </td>
      `;
        tbody.appendChild(tr);
      });
    }
    function deleteProductAction(id) {
      if (confirm("¿Seguro que quieres eliminar este producto?")) {
        products.deleteProduct(id);
        renderProducts();
      }
    }
    function editProduct(id) {
      const p = products.getProducts().find(prod => prod.id === id);
      if (!p) return;
      document.getElementById("staticBackdropLabel").innerText = "Editar Producto";
      nameInput.value = p.name;
      stockInput.value = p.stock;
      priceInput.value = p.price;
      imgInput.value = "";
      document.getElementById("saveProdBtn").setAttribute("data-edit-id", id);
      const modal = new bootstrap.Modal(document.getElementById("staticBackdrop"));
      modal.show();
    }
    function saveProduct() {
      const name = nameInput.value.trim();
      const stock = parseInt(stockInput.value.trim()) || 0;
      const price = parseFloat(priceInput.value.trim()) || 0;
      if (!name) {
        alert("El nombre es obligatorio");
        return;
      }
      const editId = document.getElementById("saveProdBtn").getAttribute("data-edit-id");
      const file = imgInput.files[0];
      // ALGO PARA GUARDAR LOS PRODUCTOS - NOSE SI SE IMPLEMENTO
      const doSave = (imgData) => {
        if (editId) {
          const newProd = { id: editId, name, stock, price, img: imgData };
          products.updateProduct(editId, newProd);
          document.getElementById("saveProdBtn").removeAttribute("data-edit-id");
        } else {
          const newProd = { id: Date.now().toString(), name, stock, price, img: imgData };
          products.addProduct(newProd);
        }
        renderProducts();
        resetModal();
      };
      if (file) {
        const reader = new FileReader();
        reader.onloadend = () => doSave(reader.result);
        reader.readAsDataURL(file);
      } else {
        // si no se subió archivo, usa imagen por defecto
        doSave("img/reno.png");
      }
    }
    function resetModal() {
      const modalEl = document.getElementById("staticBackdrop");
      const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modal.hide();      
      document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());
      document.getElementById("staticBackdropLabel").innerText = "Nuevo Producto";
      nameInput.value = "";
      stockInput.value = "";
      priceInput.value = "";
      imgInput.value = "";
    }
    document.addEventListener("DOMContentLoaded", () => {
      renderProducts();
      document.getElementById("saveProdBtn").addEventListener("click", saveProduct);
    });
  </script>
<!-- BLOQUEO PARA REDIRECCIONAR CUALQUIER USUARIO NO ADMIN -->
  <script>
    const currentUser = JSON.parse(localStorage.getItem("APP_CURRENT_USER"));
    if (!currentUser || currentUser.role !== "admin") {
      window.location.href = "inicio.html";
    }
  </script>

</body>

</html>