<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <title>Admin Productos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/adminPage.css">
</head>

<body>
    <div id="header-placeholder"></div>
    <!-- ----------------------------------contenido------------------------- -->
    <br>
    <nav class="nav">
        <h1>Administrador de productos</h1>
        <button type="button" class="btn btn-outline-warning m-5" data-bs-toggle="modal"
            data-bs-target="#staticBackdrop">Nuevo Producto</button>
    </nav>
    <br>
    <div class="table-responsive">
        <table class="table table-striped align-middle" id="tablaProductos">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Producto</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    </main>
    <!-- MODEL -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Modal title</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <input type="email" class="form-control" id="floatingInput" placeholder="name@example.com">
                        <label for="floatingInput">Nombre Producto</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="floatingPassword" placeholder="Password">
                        <label for="floatingPassword">Cantidad</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="floatingPassword" placeholder="Password">
                        <label for="floatingPassword">Precio</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Imagen (JPG/PNG, máx ~1MB)</label>
                        <input id="prodImg" type="file" accept="image/*" class="form-control">
                        <div class="form-text">Opcional. Si no subes, se usará una imagen por defecto.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning">Guardar</button>
                </div>
            </div>
        </div>
    </div>  
    <div id="footer-placeholder"></div>
    <script>
        fetch('header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-placeholder').innerHTML = data;
            });
        fetch('footer.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('footer-placeholder').innerHTML = data;
            });
    </script>    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    
   <!-- REVISAR -->

    <script>
        const PROD_KEY = "APP_PRODS";
        function getProds() { try { return JSON.parse(localStorage.getItem(PROD_KEY)) || []; } catch { return []; } }
        function saveProds(p) { localStorage.setItem(PROD_KEY, JSON.stringify(p)); }

        // ===== Imagen: lectura/compresión =====
        let currentImgData = ""; // DataURL actual del modal

        function readFileAsDataURL(file) {
            return new Promise((res, rej) => {
                const fr = new FileReader();
                fr.onload = () => res(fr.result);
                fr.onerror = rej;
                fr.readAsDataURL(file);
            });
        }

        // Reescala máximo 800px, calidad 0.85
        async function compressImage(dataURL, maxSize = 800, mime = 'image/jpeg', quality = 0.85) {
            return new Promise((res) => {
                const img = new Image();
                img.onload = () => {
                    const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
                    const w = Math.round(img.width * scale);
                    const h = Math.round(img.height * scale);
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    res(canvas.toDataURL(mime, quality));
                };
                img.src = dataURL;
            });
        }

        function renderTabla() {
            const prods = getProds();
            const $tbody = $("#tablaProductos tbody").empty();
            prods.forEach((p, i) => {
                const thumb = p.img || `https://picsum.photos/seed/prod${p.id}/60/40`;
                $tbody.append(`
          <tr>
            <td>${i + 1}</td>
            <td class="d-flex align-items-center gap-2">
              <img src="${thumb}" style="width:60px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #ddd">
              <span>${p.nombre}</span>
            </td>
            <td>$${p.precio}</td>
            <td>${p.stock}</td>
            <td>
              <button class="btn btn-sm btn-primary editar" data-id="${p.id}">Editar</button>
              <button class="btn btn-sm btn-danger eliminar" data-id="${p.id}">Eliminar</button>
            </td>
          </tr>
        `);
            });
        }

        $(function () {
            // Guards
            const user = AuthStore.getCurrentUser();
            if (!user) { location.href = "login.html"; return; }
            if (user.role !== "admin") { location.href = "index.html"; return; }

            Layout.loadPartials();
            renderTabla();

            // Nuevo
            $("#btnNuevo").on("click", () => {
                $("#prodId").val("");
                $("#prodNombre, #prodPrecio, #prodStock").val("");
                $("#prodImg").val("");
                currentImgData = "";
                $("#prodPreview").attr("src", "").addClass("d-none");
                new bootstrap.Modal("#productoModal").show();
            });

            // Cargar imagen
            $("#prodImg").on("change", async function () {
                const file = this.files[0];
                if (!file) return;
                if (!/image\/(png|jpeg|jpg)/i.test(file.type)) { alert("Sube JPG o PNG"); this.value = ""; return; }
                if (file.size > 1.2 * 1024 * 1024) { /* aviso, se comprime igual */ }
                try {
                    const raw = await readFileAsDataURL(file);
                    currentImgData = await compressImage(raw, 800, 'image/jpeg', 0.85);
                    $("#prodPreview").attr("src", currentImgData).removeClass("d-none");
                } catch (e) { console.warn(e); alert("No se pudo leer la imagen."); }
            });

            // Guardar
            $("#btnGuardarProd").on("click", () => {
                const id = $("#prodId").val();
                const prods = getProds();
                if (id) {
                    const idx = prods.findIndex(p => String(p.id) === String(id));
                    prods[idx].nombre = $("#prodNombre").val();
                    prods[idx].precio = $("#prodPrecio").val();
                    prods[idx].stock = $("#prodStock").val();
                    if (currentImgData) prods[idx].img = currentImgData; // reemplaza solo si subió nueva
                } else {
                    prods.push({
                        id: Date.now(),
                        nombre: $("#prodNombre").val(),
                        precio: $("#prodPrecio").val(),
                        stock: $("#prodStock").val(),
                        img: currentImgData || ""
                    });
                }
                saveProds(prods);
                renderTabla();
                bootstrap.Modal.getInstance(document.getElementById("productoModal")).hide();
            });

            // Editar
            $(document).on("click", ".editar", function () {
                const p = getProds().find(x => String(x.id) === String($(this).data("id")));
                $("#prodId").val(p.id);
                $("#prodNombre").val(p.nombre);
                $("#prodPrecio").val(p.precio);
                $("#prodStock").val(p.stock);
                $("#prodImg").val("");
                currentImgData = "";
                if (p.img) { $("#prodPreview").attr("src", p.img).removeClass("d-none"); }
                else { $("#prodPreview").attr("src", "").addClass("d-none"); }
                new bootstrap.Modal("#productoModal").show();
            });

            // Eliminar
            $(document).on("click", ".eliminar", function () {
                let prods = getProds().filter(x => String(x.id) !== String($(this).data("id")));
                saveProds(prods);
                renderTabla();
            });
        });
    </script>
</body>
</html>