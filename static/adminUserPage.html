<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiguraLab</title>
    <link rel="icon" href="img/reno.png" type="image/png" sizes="32x32">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/adminPage.css">
</head>

<body>
    <div id="header-placeholder"></div>
    <!-- ----------------------------------contenido------------------------- -->
    <br>
    <nav class="nav">
        <h1>Administrador de Usuarios</h1>
        <button type="button" class="btn btn-outline-warning m-3" data-bs-toggle="modal"
            data-bs-target="#staticBackdrop">Nuevo Usuario</button>
    </nav>
    <br>
    <div class="table-responsive">
        <table class="table table-striped align-middle" id="tablaProductos">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <!-- MODAL -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Nuevo Usuario</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="name" placeholder="Nombre Usuario">
                        <label for="name">Nombre Usuario</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="email" class="form-control" id="email" placeholder="Email">
                        <label for="email">Email</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="pass" placeholder="Password">
                        <label for="pass">Contraseña</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="rol" placeholder="Rol">
                        <label for="rol">Rol</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="saveUserBtn" class="btn btn-warning">Guardar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- FOOTER -->
    <div id="footer-placeholder"></div>

    <script src="js/users.js"></script>  
    <script src="js/controlSeccion.js"></script>
    <script>
        fetch('header.html')
            .then(r => r.text())
            .then(html => {
                document.getElementById('header-placeholder').innerHTML = html;
                applySessionUI(); 
            })
            .catch(error => console.error('Error al cargar el header:', error));
    </script>    
    <script>
        fetch('footer.html')
            .then(r => r.text())
            .then(html => {
                document.getElementById('footer-placeholder').innerHTML = html;
            })
            .catch(error => console.error('Error al cargar el footer:', error));
    </script>    
    <!-- - PORQUE DUPLICADO ????? -->
    <script src="js/users.js"></script> 
    <script>       
        const nameInput = document.getElementById("name");
        const emailInput = document.getElementById("email");
        const passInput = document.getElementById("pass");
        const roleInput = document.getElementById("rol");
        // Renderizar usuarios en la tabla
        function renderUsers() {
            const tbody = document.querySelector("#tablaProductos tbody");
            tbody.innerHTML = "";
            const allUsers = users.getUsers();
            allUsers.forEach((user, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>${user.role}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-2" onclick="editUser('${user.email}')">Editar</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteUserAction('${user.email}')">Eliminar</button>
          </td>
        `;
                tbody.appendChild(tr);
            });
        }
        // Eliminar usuario
        function deleteUserAction(email) {
            if (confirm(`¿Seguro que quieres eliminar a ${email}?`)) {
                users.deleteUser(email);
                renderUsers();
            }
        }
        // Editar usuario
        function editUser(email) {
            const user = users.getUsers().find(u => u.email === email);
            if (!user) return;
            document.getElementById("staticBackdropLabel").innerText = "Editar Usuario";
            nameInput.value = user.name;
            emailInput.value = user.email;
            emailInput.readOnly = true;
            passInput.value = user.pass || "";
            roleInput.value = user.role;
            document.getElementById("saveUserBtn").setAttribute("data-edit-email", email);
            const modal = new bootstrap.Modal(document.getElementById("staticBackdrop"));
            modal.show();
        }
        // Guardar usuario (nuevo o editado)
        function saveUser() {
            const name = nameInput.value.trim();
            const email = emailInput.value.trim();
            const pass = passInput.value.trim();
            const role = roleInput.value.trim();
            if (!name || !email || !role) {
                alert("Todos los campos son obligatorios.");
                return;
            }
            const editEmail = document.getElementById("saveUserBtn").getAttribute("data-edit-email");
            if (editEmail) {
                // Editar: borrar viejo y registrar nuevo
                users.deleteUser(editEmail);
                users.registerUser({ name, email, pass });
                const all = users.getUsers();
                const idx = all.findIndex(u => u.email === email);
                if (idx !== -1) {
                    all[idx].role = role;
                    localStorage.setItem(users.LS_KEYS.USERS, JSON.stringify(all));
                }
                document.getElementById("saveUserBtn").removeAttribute("data-edit-email");
                emailInput.readOnly = false;
            } else {
                // Crear nuevo
                const result = users.registerUser({ name, email, pass });
                if (!result.ok) {
                    alert(result.message);
                    return;
                }
                const all = users.getUsers();
                const idx = all.findIndex(u => u.email === email);
                if (idx !== -1) {
                    all[idx].role = role;
                    localStorage.setItem(users.LS_KEYS.USERS, JSON.stringify(all));
                }
            }
            renderUsers();
            // Reset modal
            const modalEl = document.getElementById("staticBackdrop");
            bootstrap.Modal.getInstance(modalEl).hide();
            document.getElementById("staticBackdropLabel").innerText = "Nuevo Usuario";
            nameInput.value = "";
            emailInput.value = "";
            passInput.value = "";
            roleInput.value = "";
        }
        // Inicializar
        document.addEventListener("DOMContentLoaded", () => {
            renderUsers();
            document.getElementById("saveUserBtn").addEventListener("click", saveUser);
        });
    </script>
    <!-- BLOQUEO POR ROL -->
    <script>
        const currentUser = JSON.parse(localStorage.getItem("APP_CURRENT_USER"));
        if (!currentUser || currentUser.role !== "admin") {
            window.location.href = "inicio.html";
        }
    </script>

</body>

</html>